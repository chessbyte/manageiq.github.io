<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />
  
  <link type="text/css" rel="stylesheet" href="/assets/main-2a8106f2dc3b23b54934444c1beb424a55ed4429f4e93bbdeecf782b04184181.css">
  <link rel="canonical" href="http://manageiq.org/docs/guides/providers/dev-guide">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/guides/providers/dev-guide">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li>
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li class="active">
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<ul class="menu menu-toplevel" id="guides_menu">

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Architecture
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/capacity_and_utilization_collection_explanation">
      Capacity And Utilization Collection Explanation
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/enterprise">
      Enterprise
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/source_code_layout">
      Source Code Layout
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Developer Setup
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/plugins">
      Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/minimal_mode">
      Minimal Mode
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/running_test_suites">
      Running Test Suites
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/debugging">
      Interactive debugging
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      External Auth
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/configuration">
      Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/installation">
      Installation
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      User Interface
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/patterns">
      UI Patterns
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/plugins">
      UI Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/register_react_component">
      Shared React Component API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/report_data_api">
      Report Data API
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Providers
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_overview">
      Providers Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_database_architecture.html">
      Providers Database Architecture
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/amazon_aws_config">
      Amazon AWS Config
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/containers">
      Containers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openshift">
      Openshift
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openstack_infra_provider">
      Openstack Infra Provider
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/provisioning/windows_imaging">
      Windows Imaging
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/coding_style_and_standards">
      Coding Style And Standards
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/i18n">
      I18n
    </a>
    
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc dev_doc">
      

      <div class="doc-content">
        
        <h1 id="integration-with-manageiq">Integration with ManageIQ</h1>
<p><em>The goal of this document is to describe how to add new features to providers but
it can also help when creating a new provider from scratch.</em></p>

<h2 id="brief-summary-of-miq-architecture">Brief Summary of MiQ Architecture</h2>
<p>ManageIQ (MiQ) targets to be a high-level manager (meta-manager), i.e. the manager of other managers. In the MiQ terminology the
child managers are called providers and their goal is to provide the information from the managed system as well
as triggering the operations on the managed system. Well, to be exact, the manager is the external system, while
the provider is that part of MiQ that talks to that manager. Adding a provider that is connecting to an external system
is then <a href="http://manageiq.org/docs/get-started/add-a-provider">pretty easy</a>.</p>

<p>The task of integration of a particular system with ManageIQ can be reduced to a task of writing the corresponding
ManageIQ provider. Because the ManageIQ is a web application written in the Ruby on Rails framework, it’s quite
natural to split the task to the MVC layers.</p>

<h2 id="developer-setup">Developer Setup</h2>
<p>So as not to reinvent the wheel we recommend going to the
<a href="https://github.com/ManageIQ/guides/blob/master/developer_setup.md">developer setup</a> page and do all the
necessary steps. After this, you should be able to run the MiQ web application with typing <code class="highlighter-rouge">rails server</code> (shortly <code class="highlighter-rouge">rails s</code>)
or even <code class="highlighter-rouge">bundle exec rails server</code> which makes sure it is running in context of the current bundle (more info
<a href="http://stackoverflow.com/a/6588708/1594980">here</a>). Running this command will start the Puma server that is
listening on http://localhost:3000. The default credentials for the dev setup are <code class="highlighter-rouge">admin:smartvm</code>.</p>

<h2 id="data-flow">Data Flow</h2>
<p>Managers are responsible to feed the data into MiQ DB during the refresh operation. In the MiQ terminology it’s
feeding the MiQ inventory. This operation can be triggered explicitly from UI but it’s also done automatically
each 15 minutes. Each provider is also capable of running operations.</p>

<p>After the Developer Setup step you should be able to run the UI server. This, however, won’t spawn the worker thread
that is responsible for doing the refresh operation on providers. If you need to do also the refresh on providers,
We recommend running <code class="highlighter-rouge">rails console</code> (or <code class="highlighter-rouge">rails c</code>) in a new terminal window and typing in <code class="highlighter-rouge">simulate_queue_worker</code>. This command in the
rails console will do the work if you click in UI on the refresh button. If you want to run the refresh
directly from the rails console, you may want to do that with</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reload!</span><span class="p">;</span> <span class="no">EmsRefresh</span><span class="p">.</span><span class="nf">refresh</span><span class="p">(</span><span class="no">ExtManagementSystem</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">reload!</code> in the command is not necessary if you didn’t modify the code.</p>

<h2 id="model-layer">Model Layer</h2>
<p>When adding new features or writing new providers, the first step is usually to map the entities and relations by
model to the MiQ database, in order to be able to store the data from any external provider. We need to have the database tables prepared for it.</p>

<p>In Rails most often each entity has its own table in the database. To manage the DB changes there is a support mechanism
called migrations. Migrations allow easily migrate from one version of schema to an older one or upgrade to a new
one. So the migration scripts basically contain the described change to the schema including the creation of a new
table. They are stored in <a href="https://github.com/ManageIQ/manageiq-schema/tree/master/db/migrate">here</a> and each migration
is prefixed by the time when it was created and then followed by a brief description of what it does. Rails provide
a way to scaffold them using for instance:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate migration AddColumnNameToTableName column:string
</code></pre></div></div>

<p>This command should generate the properly named file with the following content:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AddColumnToTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span> <span class="k">def</span> <span class="nf">change</span> <span class="n">add_column</span> <span class="ss">:table_name</span><span class="p">,</span> <span class="ss">:column_name</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">end</span> <span class="k">end</span>
</code></pre></div></div>

<p>Scaffolding can make things faster, but often it’s easier to write it from scratch for more complex scenarios.</p>

<h2 id="view-layer">View Layer</h2>
<p>For more comprehensive and more general guide we recommend going
<a href="https://github.com/ManageIQ/guides/blob/master/ui/patterns.md">here</a>. The MiQ application spans multiple repositories:
the core (including models) is hosted <a href="https://github.com/ManageIQ/manageiq/">here</a> and the majority of the UI is
stored in the
<a href="https://github.com/ManageIQ/manageiq-ui-classic">ui repo</a> (contains also all the controllers). Some angular
components are in <a href="https://github.com/ManageIQ/ui-components">components repo</a> and also the providers have been refactored
out into their own repositories. 
It’s important to keep in mind that when implementing a new feature that changes the backend and also the frontend,
 multiple repositories need to be addressed.</p>

<h3 id="haml">HAML</h3>
<p>Haml is the templating mechanism used across ManageIQ. It provides a way to write the HTML code in a yaml-like language
without the need of writing the tons of nested divs. Its format is pretty simple, for instance this piece of haml code:</p>

<div class="language-haml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#content</span>
  <span class="nc">.left.column</span>
    <span class="nt">%h2</span> Welcome to our site!
    <span class="nt">%p</span><span class="p">=</span> <span class="n">print_information</span>
  <span class="nc">.right.column</span>
    <span class="p">=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s2">"sidebar"</span>
</code></pre></div></div>

<p>will be transformed into</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'content'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'left column'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Welcome to our site!<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>Output of the print_information method.<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right column"</span><span class="nt">&gt;</span>
    ... <span class="c">&lt;!-- some component included as a partial --&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>If you prefer the plain HTML or you already have your code in HTML, you may want to use
some <a href="https://html2haml.herokuapp.com/">conversion tools</a> for that.</p>

<h3 id="partials">Partials</h3>
<p>Some pieces of the UI that are used in many places can be extracted into so-called partials and reused from multiple
contexts. A partial is a HAML file whose name starts with the underscore. So for instance, one can create a file called
<code class="highlighter-rouge">_sidebar.haml</code> and reuse this by calling <code class="highlighter-rouge">render :partial =&gt; sidebar</code>. Partials can also have a “slots for data”
that are passed to the render method or one can call normal ruby methods from it similarly as in the normal HAML
files. This way we can customize them easily. A more comprehensive (and 100% better) description is
<a href="http://guides.rubyonrails.org/layouts_and_rendering.html#partial-layouts">here</a>.</p>

<h3 id="angular">Angular</h3>
<p>When Rails was created there were no single-page-apps and nodejs fancy libraries. There is a big effort to
convert as much UI code as possible into the Angular. The UI components repo mentioned above
is completely written in Angular, while the old UI contains only some parts in angular. It’s
done in a way that HAML files contains also the directives and calls to the angular controller.
Angular controllers are stored in <code class="highlighter-rouge">app/assets/javascripts/controllers/</code>.</p>

<h4 id="rxjs">RxJS</h4>
<p>The RxJS library is used in a simple way as a message bus so one can send events –<code class="highlighter-rouge">sendDataWithRx()</code>
and subscribe to a <a href="https://github.com/ReactiveX/rxjs/blob/master/doc/subject.md">Rx subject</a>
–<code class="highlighter-rouge">ManageIQ.angular.rxSubject.subscribe(event =&gt; {..})</code>.</p>

<h3 id="topology-graph">Topology Graph</h3>

<p>TODO</p>

<h2 id="controller-layer">Controller Layer</h2>
<p>While the model and most of the business logic is in the <code class="highlighter-rouge">manageiq/manageiq</code> repository, the controller+view is in <code class="highlighter-rouge">manageiq/manageiq-ui-classic</code> repo.</p>

<h3 id="router">Router</h3>
<p>In Rails apps, all the possible actions must be whitelisted in the router configuration. In the case of MiQ, the router is
<a href="https://github.com/ManageIQ/manageiq-ui-classic/blob/036735fcd678430376402f7d81f7d0d7e5c69e5b/config/routes.rb">here</a>.
Most common actions are:</p>

<ul>
  <li><code class="highlighter-rouge">show</code> (detail page of entity),</li>
  <li><code class="highlighter-rouge">show_list</code> (list of n entities),</li>
  <li><code class="highlighter-rouge">new</code> &amp; <code class="highlighter-rouge">edit</code> (if creating and editing is supported)</li>
  <li><code class="highlighter-rouge">tagging_edit</code> &amp; <code class="highlighter-rouge">tag_edit_form_field_changed</code> (tagging mechanism in MiQ)</li>
  <li><code class="highlighter-rouge">button</code> (when clicking on a button in the toolbar, this action is invoked)</li>
  <li><code class="highlighter-rouge">quick_search</code> (if we want the search form field in the GTL (grid, tiles, list) view)</li>
  <li><code class="highlighter-rouge">perf_top_chart</code> (metrics)</li>
  <li>…</li>
</ul>

<p>NOTE: These actions are implemented by actual methods on the corresponding controller class. So for instance if http get is sent
to <code class="highlighter-rouge">http://localhost:3000/container/show/26</code> the method <code class="highlighter-rouge">show</code> in the <code class="highlighter-rouge">container_controller.rb</code> is invoked
and the <code class="highlighter-rouge">container</code> entity with id <code class="highlighter-rouge">26</code> will be accessible in the <code class="highlighter-rouge">@record</code> variable. After further processing like
(setting the <code class="highlighter-rouge">@display</code>) the data will be rendered using those corresponding HAML template files. For the described example,
this <a href="https://github.com/ManageIQ/manageiq-ui-classic/blob/256e9aa5f13de59db943fb581ec4bc56f3dcd591/app/views/container/show.html.haml">file</a> will be used.
Again, the naming is absolutely crucial here, because everything should auto-magically work when preserving those conventions.</p>

<h2 id="gluing-everything-together">Gluing Everything Together</h2>
<p>Unfortunately, there is no easy way here. Due to some legacy code, often, it is necessary to add the entity
name to some long list of other entity names to achieve a simple task. The best way to struggle with it
is using the debugger and trying to figure out why it’s not working as it should (somewhere in the chain there must be a check,
if the current entity name is in some list). Another approach is to look to some existent PRs that were adding similar features and check what files
need to be modified.</p>

<h3 id="places-that-needs-attention">Places that needs attention</h3>
<p>Here is a list of some of the pain points that need attention when changing the provider-related code:</p>

<ul>
  <li>in the backend repo:
    <ul>
      <li><code class="highlighter-rouge">db/fixtures/miq_product_features.yml</code> (list of features that a role can do on entity, used by RBAC)</li>
      <li><code class="highlighter-rouge">app/models/ems_refresh/</code> (refresh logic of the provider, basically consumes the output of <code class="highlighter-rouge">refresh_parser.sh</code>)</li>
      <li><code class="highlighter-rouge">product/views/YourNewEntity.yaml</code> (although this is only report config, it’s necessary for UI to work properly, check for the similar in the directory)</li>
    </ul>
  </li>
  <li>in the frontend repo:
    <ul>
      <li><code class="highlighter-rouge">config/routes.rb</code> (this was described in the Router section)</li>
      <li><code class="highlighter-rouge">app/decorators/your_new_entity_decorator.rb</code> (there is a convention to put a placeholder icons here)</li>
      <li><code class="highlighter-rouge">app/controllers/your_new_entity_controller.rb</code> (the controller for the entity)</li>
      <li><code class="highlighter-rouge">app/views/your_new_entity/{show|_main|show_list|some_other_action|_some_other_partial}.html.haml</code></li>
      <li><code class="highlighter-rouge">app/views/layouts/listnav/_your_new_entity.html.haml</code> (the side panel, this needs to be also registered in <code class="highlighter-rouge">ApplicationHelper.render_listnav_filename</code>)</li>
      <li><code class="highlighter-rouge">app/helpers/your_new_entity_helper/textual_summary.rb</code></li>
      <li><code class="highlighter-rouge">app/helpers/your_new_entity_helper.rb</code></li>
      <li><code class="highlighter-rouge">app/views/configuration/_ui_2.html.haml</code></li>
      <li><code class="highlighter-rouge">app/views/layouts/listnav/</code> (if you need direct link in web UI from provider)</li>
      <li><code class="highlighter-rouge">app/views/shared/views/ems_common/_show.html.haml</code> (same as ^)</li>
      <li><code class="highlighter-rouge">app/helpers/application_helper.rb</code> (multiple use-cases)</li>
      <li><code class="highlighter-rouge">/app/helpers/application_helper/toolbar_chooser.rb</code> (toolbar with buttons)</li>
      <li><code class="highlighter-rouge">/app/helpers/application_helper/toolbar/your_new_entity_center.rb</code> (description of what buttons are allowed for 1 entity)</li>
      <li><code class="highlighter-rouge">/app/helpers/application_helper/toolbar/your_new_entities_center.rb</code> (same as above, except it’s for the GTL view)</li>
      <li><code class="highlighter-rouge">app/views/layouts/_perf_options.html.haml</code> (metrics)</li>
    </ul>
  </li>
</ul>

<h2 id="debugging">Debugging</h2>
<h3 id="logs">Logs</h3>
<p>There are actually two log files where you can find what is wrong.</p>

<ul>
  <li><code class="highlighter-rouge">log/evm.log</code></li>
  <li><code class="highlighter-rouge">log/development.log</code></li>
</ul>

<p>There should be a lot of SQL queries that may be handy during the development. Of course, you can use them in the good old <code class="highlighter-rouge">psql</code> client.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql <span class="nt">-U</span> postgres vmdb_development
</code></pre></div></div>
<p>The command should open the Postgres client on the dev db. By default the development environment is active, this can be changed
by <code class="highlighter-rouge">rails s -e production</code>.</p>

<p>Even better option is to inspect the db with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">exec </span>rails dbconsole
</code></pre></div></div>

<p>This command takes into consideration the actual environment and the configured database.</p>

<h3 id="pry">Pry</h3>
<p>Pry is a command line oriented debugger similar to famous <code class="highlighter-rouge">gdb</code>.
We suggest adding this line to <code class="highlighter-rouge">Gemfile.dev.rb</code> (create this file if it doesn’t exist in the root of manageiq/manageiq repo):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'pry-byebug'</span>
</code></pre></div></div>
<p>Then after running <code class="highlighter-rouge">bundle install</code>, you should be all set. Now, adding the breakpoint means writing <code class="highlighter-rouge">binding.pry</code> somewhere in the code.
Once the ruby executes the code with this line, it stops the execution and opens a REPL where Ruby code can be inspected and executed.</p>

<p>TIP: This works also for the HAML files. But instead of using just <code class="highlighter-rouge">binding.pry</code>, use <code class="highlighter-rouge">- binding.pry</code> (and respect the indentation of the file).</p>

<h3 id="console">Console</h3>
<p>Another way of debugging is just printing the variables to the console by <code class="highlighter-rouge">puts foo</code>. Object can have the <code class="highlighter-rouge">.to_s</code> method that
is responsible for printing the object (equivalent to <code class="highlighter-rouge">.toString()</code> method in Java), if the <code class="highlighter-rouge">.to_s</code> method is not implemented,
you can use the <code class="highlighter-rouge">.inspect</code> method that provides the info about the object.</p>

<h2 id="rails-console">Rails Console</h2>
<p>In Rails apps, you can use rails console by typing the <code class="highlighter-rouge">rails console</code> or <code class="highlighter-rouge">rails c</code> to the command line
(being in the root of the repo). This opens the REPL Ruby console, where you can type in Ruby code and it evaluates it.
What’s interesting here is that you can actually alter the running Rails application by:</p>

<ul>
  <li>creating new entities: <code class="highlighter-rouge">MyAwesomeEntity.create(params)</code></li>
  <li>finding entities: <code class="highlighter-rouge">MyAwesomeEntity.all</code> / <code class="highlighter-rouge">MyAwesomeEntity.find(foo: 'bar')</code></li>
  <li>delete: <code class="highlighter-rouge">MyAwesomeEntity.find(foo: 'bar').destroy</code> / <code class="highlighter-rouge">MyAwesomeEntity.delete(foo: 'bar')</code></li>
  <li>…</li>
</ul>

<p>The methods like <code class="highlighter-rouge">.create</code>, <code class="highlighter-rouge">.all</code>, <code class="highlighter-rouge">.find</code> are actually not defined on the models, but comes from the ActiveRecord (~ORM) framework.</p>

<h2 id="code-style">Code Style</h2>
<p>For up-to-date coding standards, consult this <a href="https://github.com/ManageIQ/guides/blob/master/coding_style_and_standards.md">guide</a>.
The travis build is set to check what rules are violated and report those in the PR comment. If you want to run it locally, just
type in: <code class="highlighter-rouge">rubocop</code> and/or <code class="highlighter-rouge">haml-lint</code> (if necessary, install those ruby gems).</p>

<p>There is also a bash helper script called <a href="https://github.com/zeari/miq-helpers/blob/master/murphy.sh"><code class="highlighter-rouge">murphy.sh</code></a>
 that runs the <code class="highlighter-rouge">rubocop</code> and <code class="highlighter-rouge">haml-lint</code> only on those commits that haven’t been pushed yet.
It is similar to the <code class="highlighter-rouge">rubocop-git</code> gem.</p>

<h1 id="common-tasks">Common Tasks</h1>
<p>Rather than trying to describe each part separately as before, here we would like to focus on some common tasks and provide a link to
PRs/commits that did so in the past.</p>

<h2 id="creating-new-models-and-migrations">Creating new Models and Migrations</h2>
<p>As mentioned above, there is a scaffolding helper for creating the migrations. The database knows its current version, so
if there is a new migration that hasn’t been applied, it will get applied when running <code class="highlighter-rouge">rake db:migrate</code>. In case there was
anything wrong with the migration, one can go back and undo it by <code class="highlighter-rouge">rake db:rollback</code>, change the migration file and try again.</p>

<p><a href="http://edgeguides.rubyonrails.org/active_record_migrations.html">documentation</a></p>

<h2 id="handling-the-refresh-logic-and-saving-to-the-db">Handling the Refresh Logic and Saving to the DB</h2>

<p>Refresh logic mostly happens in a <code class="highlighter-rouge">refresh_parser.rb</code> class. Parsed entities are then processed by core <code class="highlighter-rouge">ems_refresh.rb</code>.
The logic in this class has
quite strong assumptions on the data being stored. It assumes that it has the tree structure and each entity contains its kids as a nested hash.
If you are able to achieve that structure in the <code class="highlighter-rouge">refresh_parser.rb</code>, you are halfway done. Otherwise, good luck :]</p>

<h3 id="defining-inventory">Defining Inventory</h3>

<p>Providers which use graph refresh consists of Collector, Persister and Parser classes.
When the Collector loads data from an external provider, the Persister defines the inventory structure based on InventoryCollection objects. 
Inventory is then saved to the VMDB (app database). Each inventory collection is mapped to an ActiveRecord model.
Parser maps data collected from the provider to the common format defined by the ActiveRecord model.</p>

<p>THe persister InventoryCollection definition is described <a href="persister/inventory_collections">here</a>.</p>

<h2 id="registering-the-features-for-rbac">Registering the Features for RBAC</h2>
<p>If everything is as it should be but you still can’t see anything in the UI, permissions may be the reason. MiQ has the RBAC model
that checks if the user in the current role is able to access the feature. This is described in the yaml file called <code class="highlighter-rouge">miq_product_features.yml</code>.</p>

<p>When adding the new entity, it is also necessary add the record
<a href="https://github.com/ManageIQ/manageiq/blob/master/db/fixtures/miq_product_features.yml">here</a> and describe it.
It is best to copy&amp;paste the existing definition and change the details.</p>

<h2 id="if-the-side-panel-or-toolbar-is-missing">If the Side Panel or Toolbar is Missing</h2>
<p>If the screen should have the left panel with navigation, it needs the be whitelisted in:
<code class="highlighter-rouge">ApplicationHelper.render_listnav_filename</code>. There are more places in that “god file” where new entity needs to be
registered (for instance if it wants to participate in the GTL views).</p>

<p>The side navigation layout is described in <code class="highlighter-rouge">/app/views/layouts/listnav/_X.html.haml</code></p>

<p>As for the missing toolbar, adding the plural of the entity name for list and singular for the detail page to this file
<code class="highlighter-rouge">/app/helpers/application_helper/toolbar/Xs_center.rb</code> is needed + register itself here:
<code class="highlighter-rouge">/app/helpers/application_helper/toolbar_chooser.rb:439</code> (2 places in that file, 1 for singular and 1 for plural).
Then it automagically should work.</p>

<h2 id="exposing-the-live-metrics-for-entity">Exposing the Live Metrics for Entity</h2>

<p>If the metric graphs should be displayed for your entity, you need to do the following:</p>

<ul>
  <li><code class="highlighter-rouge">app/controllers/application_controller/performance.rb</code>,</li>
  <li>including the <code class="highlighter-rouge">LiveMetricMixin</code> in the entity model,</li>
  <li>creating the entity that ends with <code class="highlighter-rouge">Perf</code>, etc.</li>
  <li>changing <code class="highlighter-rouge">app/views/layouts/_perf_options.html.haml</code></li>
  <li>the <code class="highlighter-rouge">show.haml</code> of the entity has to contain:</li>
</ul>

<div class="language-haml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span> <span class="k">if</span> <span class="vi">@showtype</span> <span class="o">==</span> <span class="s2">"performance"</span>
    <span class="p">=</span> <span class="n">render</span><span class="p">(</span><span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s2">"layouts/performance"</span><span class="p">)</span>
    <span class="nd">:javascript
</span>      <span class="kd">var</span> <span class="nx">miq_after_onload</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">miqAsyncAjax('</span><span class="si">#{</span><span class="n">url_for</span><span class="p">(</span><span class="ss">:action</span> <span class="o">=&gt;</span> <span class="vi">@ajax_action</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@record</span><span class="p">)</span><span class="si">}</span><span class="s2">');</span><span class="dl">"</span>
</code></pre></div></div>

<ul>
  <li>adding <code class="highlighter-rouge">perf_chart_chooser</code> action into <code class="highlighter-rouge">router.rb</code> to corresponding entity</li>
  <li>adding to <code class="highlighter-rouge">db/fixtures/miq_product_features.yml</code> (<code class="highlighter-rouge">X</code> is the entity name)</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">:name: Utilization</span>
    <span class="s">:description: Show Capacity &amp; Utilization data of X</span>
    <span class="s">:feature_type: view</span>
    <span class="s">:identifier: X_perf</span>
</code></pre></div></div>

<ul>
  <li>create <code class="highlighter-rouge">/product/live_metric_X.yaml</code> similar to the existing ones</li>
  <li>creating a yaml file in <code class="highlighter-rouge">product/charts/layouts/{Y}_perf_charts/X.yaml</code> similar to the existing ones (<code class="highlighter-rouge">X</code> is entity name and Y is the interval or “realtime” phrase). The cols ids must match with the ids defined in <code class="highlighter-rouge">/product/live_metric_X.yaml</code></li>
  <li>add the tests</li>
</ul>


      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2020 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
