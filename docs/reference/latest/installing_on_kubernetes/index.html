<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <link type="text/css" rel="stylesheet" href="/assets/main-8de063b063e781c83c3900f2fb42692885edeac0346d54e22467184ccc393942.css">
  <link rel="canonical" href="http://manageiq.org/docs/reference/latest/installing_on_kubernetes/">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/reference/latest/installing_on_kubernetes/index">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li class="active">
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li>
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<div class="doc_menu-heading">
  Latest
</div>

<ul class="menu menu-toplevel" id=ref_menu_latest>


  <li class="menu-parent">
    
    <a href="#">
      Installation
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_aws/index.html">
      Amazon Web Services (AWS)
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item active">
    <a href="/docs/reference/latest/installing_on_kubernetes/index.html">
      Kubernetes
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_ibm_cloud/index.html">
      IBM Cloud
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_microsoft_azure/index.html">
      Microsoft Azure
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_google_compute_engine/index.html">
      Google Compute Engine
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_vmware_vsphere/index.html">
      VMware vSphere
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_red_hat_enterprise_linux_openstack_platform/index.html">
      Red Hat Enterprise OpenStack Platform
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_red_hat_virtualization/index.html">
      Red Hat Enterprise Virtualization
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/installing_on_scvmm/index.html">
      Microsoft System Center Virtual Machine Manager (SCVMM)
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Configuration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/deployment_planning_guide/index.html">
      Deployment Planning Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/general_configuration/index.html">
      General Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/high_availability_guide/index.html">
      High Availability Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/appliance_hardening_guide/index.html">
      Appliance Hardening Guide
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Administration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/monitoring_alerts_and_reporting/index.html">
      Monitoring, Alerts, and Reporting
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/policies_and_profiles_guide/index.html">
      Policies and Profiles Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/managing_infrastructure_and_inventory/index.html">
      Managing Infrastructure and Inventory
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/managing_providers/index.html">
      Managing Providers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/provisioning_virtual_machines_and_hosts/index.html">
      Provisioning Virtual Machines and Hosts
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/scripting_actions/index.html">
      Scripting Actions in ManageIQ
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Authentication
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/auth/active_directory.html">
      Active Directory
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/auth/ipa_2fa.html">
      2-Factor-Authentication with IPA
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/auth/ipa_ad_trust.html">
      IPA/AD Trust
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/auth/ldap.html">
      LDAP
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/auth/saml.html">
      SAML
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/auth/openid_connect.html">
      OpenID-Connect
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Integration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/integration_with_aws_cloudformation_and_openstack_heat/index.html">
      AWS CloudFormation and OpenStack Heat
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/integration_with_servicenow/index.html">
      ServiceNow
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Reference
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/capabilities_matrix/index.html">
      Capabilities Matrix
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/rest_api/index.html">
      ManageIQ REST API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/latest/methods_available_for_automation/index.html">
      Methods Available for Automation
    </a>
    
  </li>


      </ul>
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc user_doc">
      

      <div class="doc-content">
        
        <div class="doc-versions">
          <span class="label">Versions: </span>
          
            <span class="active" >
              <a href="/docs/reference/latest/installing_on_kubernetes/index.html">
                Latest
              </a>
            </span>
            
          
        </div>
        
        <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#installing-on-kubernetes--openshift">Installing on Kubernetes / Openshift</a>
<ul>
<li class="toc-entry toc-h2"><a href="#preparing-the-kubernetes-namespace">Preparing the Kubernetes namespace</a></li>
<li class="toc-entry toc-h2"><a href="#migrating-from-appliances">Migrating from Appliances</a>
<ul>
<li class="toc-entry toc-h3"><a href="#notes">Notes</a></li>
<li class="toc-entry toc-h3"><a href="#collect-data-from-the-appliance">Collect data from the appliance</a></li>
<li class="toc-entry toc-h3"><a href="#restore-the-backup-into-the-kubernetes-environment">Restore the backup into the kubernetes environment</a></li>
</ul>
</li>
</ul>
</li>
</ul><h1 id="installing-on-kubernetes--openshift">
<a class="anchor" href="#installing-on-kubernetes--openshift" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing on Kubernetes / Openshift</h1>

<h2 id="preparing-the-kubernetes-namespace">
<a class="anchor" href="#preparing-the-kubernetes-namespace" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preparing the Kubernetes namespace</h2>
<p>The deploy directory referenced below can be found <a href="https://github.com/ManageIQ/manageiq-pods/tree/master/manageiq-operator/deploy">here</a></p>

<ol>
  <li>
    <p>Search for the Custom Resource Definition (CRD) and create it if it doesn’t already exist.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc get crds | grep manageiqs.manageiq.org
 $ oc create -f deploy/crds/manageiq.org_manageiqs_crd.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set up RBAC.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f deploy/role.yaml
 $ oc create -f deploy/role_binding.yaml
 $ oc create -f deploy/service_account.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Deploy the operator in your namespace.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f deploy/operator.yaml
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="migrating-from-appliances">
<a class="anchor" href="#migrating-from-appliances" aria-hidden="true"><span class="octicon octicon-link"></span></a>Migrating from Appliances</h2>

<h3 id="notes">
<a class="anchor" href="#notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Notes</h3>

<ul>
  <li>
    <p>Multi-server / multi-zone:
Current architecture in podified limits us to running a single server and zone in a Kubernetes namespace.
Therefore, when migrating from a multi-appliance and/or multi-zone appliance architecture, you will need to choose a single server to assume the identity of.
This server should have the UI and web service roles enabled before taking the database backup to ensure that those workers will start when deployed in the podified environment.
All desired roles and settings will need to be configured on this server.</p>
  </li>
  <li>
    <p>Multi-region:
Multi-region deployments are slightly more complicated in a podified environment since postgres isn’t as easily exposed outside the project / cluster.
If all of the region databases are running outside of the cluster or all of the remote region databases are running outside of the cluster and the global database is in the cluster, everything is configured in the same way as appliances.
If the global region database is migrated from an appliance to a pod, the replication subscriptions will need to be recreated.
If any of the remote region databases are running in the cluster, the <code class="language-plaintext highlighter-rouge">postgresql</code> service for those databases will need to be exposed using a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport">node port</a>.
To publish the postgresql service on a node port, patch the service using <code class="language-plaintext highlighter-rouge">$ kubectl patch service/postgresql --patch '{"spec": {"type": "NodePort"}}'</code>.
Now you will see the node port listed (31871 in this example) as well as the internal service port (5432).  This node port can be used along with the IP address of any node in the cluster to access the postgresql service.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  $ oc get service/postgresql
  NAME         TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE
  postgresql   NodePort   192.0.2.1    &lt;none&gt;        5432:31871/TCP   2m
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="collect-data-from-the-appliance">
<a class="anchor" href="#collect-data-from-the-appliance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Collect data from the appliance</h3>
<ol>
  <li>
    <p>Take a backup of the database</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ pg_dump -Fc -d vmdb_production &gt; /root/pg_dump
</code></pre></div>    </div>
  </li>
  <li>
    <p>Export the encryption key and Base64 encode it for the Kubernetes Secret.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ vmdb &amp;&amp; rails r "puts Base64.encode64(ManageIQ::Password.v2_key.to_s)"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Get the region number</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ vmdb &amp;&amp; rails r "puts MiqRegion.my_region.region"
</code></pre></div>    </div>
  </li>
  <li>
    <p>Get the GUID of the server that you want to run as.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ vmdb &amp;&amp; cat GUID
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="restore-the-backup-into-the-kubernetes-environment">
<a class="anchor" href="#restore-the-backup-into-the-kubernetes-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Restore the backup into the kubernetes environment</h3>
<ol>
  <li>
    <p>Create a YAML file defining the Custom Resource (CR). Minimally you’ll need the following:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> apiVersion: manageiq.org/v1alpha1
 kind: ManageIQ
 metadata:
   name: &lt;friendly name for you CR instance&gt;
 spec:
   applicationDomain: &lt;your application domain name&gt;
   databaseRegion: &lt;region number from the appliance above&gt;
   serverGuid: &lt;GUID value from appliance above&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create the CR in your namespace. Once created, the operator will create several additional resources and start deploying the app.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f &lt;file name from above&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Edit the app secret inserting the encryption key from the appliance. Replace the “encryption-key” value with the value we exported from the appliance above.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc edit secret app-secrets
</code></pre></div>    </div>
  </li>
  <li>
    <p>Find the orchestrator pod and start a debug session into it. Keep this running in the background…</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc get pods -o name | grep orchestrator
 $ oc debug pod/orchestrator-123456abcd-789ef
</code></pre></div>    </div>
  </li>
  <li>
    <p>Temporarily prevent the orchestrator from starting by adding the following to the deployment:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc edit deployment/orchestrator

 spec:
   template:
     spec:
       nodeSelector:
         kubernetes.io/hostname: nope
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the old replica set, the new one will sit in “pending” state.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc delete replicaset.apps/orchestrator-123456abcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>Back in the debug pod from step 4:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ cd /var/www/miq/vmdb
 $ source ./container_env
 $ DISABLE_DATABASE_ENVIRONMENT_CHECK=1 rake db:drop db:create
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">oc rsh</code> into the database pod and restore the database backup</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ cd /var/lib/pgsql
 # --- download your backup here ---
 $ pg_restore -d vmdb_production &lt;your_backup_file&gt;
 $ rm -f &lt;your_backup_file&gt;
 $ exit
</code></pre></div>    </div>
  </li>
  <li>
    <p>Back in the debug pod from step 4:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ rake db:migrate
 $ exit
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the node selector that we added above <code class="language-plaintext highlighter-rouge">oc edit deployment/orchestrator</code> removing:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>spec:
  template:
    spec:
      nodeSelector:
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the pending orchestrator deployment</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc delete replicaset.apps/orchestrator-98765cba
</code></pre></div>    </div>
  </li>
</ol>

<p>Done! The orchestrator will start deploying the rest of the pods required to run the application.</p>



      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2020 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
