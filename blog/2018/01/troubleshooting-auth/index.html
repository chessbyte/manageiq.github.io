<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ - Troubleshooting ManageIQ Authentication</title>
  <meta name="description" content="The goal of this blog post is to provide a basic understanding of:  ManageIQ authentication configurations  How to troubleshoot the technologies supporting M...">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />
  
  <link type="text/css" rel="stylesheet" href="/assets/main-412c594495c704da596cbb3d877ad18c43c772fc419857af7e1eff04fdff6542.css">
  <link rel="canonical" href="http://manageiq.org/blog/2018/01/troubleshooting-auth/">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li class="active">
    <a href="/blog/">Blog</a>
  </li>
</ul>

  </div>
</header>


    <main data-url="/blog/2018/01/troubleshooting-auth/">
      <div class="blog">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-10">
        <header class="blog_header">
          <h1>
            ManageIQ Blog
          </h1>
        </header>
      </div>
    </div>
    <div class="row"> 
      <div class="col-xs-12 col-sm-10 blog_main">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="page-title" itemprop="name headline">Troubleshooting ManageIQ Authentication</h1>

            <div class="post-meta">
              <time datetime="2018-01-31T00:00:00+00:00" itemprop="datePublished">
                Jan 31, 2018
              </time>

              
              <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                by
                <i itemprop="name">
                  jvlcek
                </i>
              </span>
              

              <ul class="post-tags">
                
                <li>
                  <a href="/blog/tags/tutorials">tutorials</a>
                </li>
                
              </ul>
            </div>
          </header>

          <div class="post-content" itemprop="articleBody">
            <p>The goal of this blog post is to provide a basic understanding of:</p>
<ol>
  <li>ManageIQ authentication configurations</li>
  <li>How to <em>troubleshoot</em> the technologies supporting ManageIQ authentication.</li>
  <li>What to provide to engineering when an irresolvable ManageIQ authentication issue is encountered.</li>
</ol>

<h2 id="contents"><strong>Contents:</strong></h2>

<ul>
  <li><a href="#technologies-supporting-manageiq-authentication-modes"><strong>Technologies Supporting ManageIQ Authentication Modes</strong></a></li>
  <li><a href="#manageiq-groups-and-roles"><strong>ManageIQ Groups and Roles</strong></a></li>
  <li><a href="#manageiq-authentication-data"><strong>ManageIQ Authentication Data</strong></a></li>
  <li><a href="#saml-a-different-beast"><strong>SAML A different beast</strong></a></li>
  <li><a href="#common-misconceptions"><strong>Common Misconceptions</strong></a></li>
  <li><a href="#reporting-authentication-issues"><strong>Reporting Authentication Issues</strong></a></li>
  <li><a href="#appendix"><strong>Appendix: The Gory Details</strong></a>
    <ul>
      <li><a href="#capturing-manageiq-log-files">Capturing ManageIQ Log Files</a></li>
      <li><a href="#capturing-authentication-data-from-manageiq-db">Capturing Authentication Data From ManageIQ DB</a></li>
      <li><a href="#confirming-ldap-configuration">Confirming LDAP Configuration</a></li>
      <li><a href="#confirming-sssd-configuration">Confirming SSSD Configuration</a></li>
      <li><a href="#diagnosing-failed-dbus-commands">Diagnosing Failed dbus Commands</a></li>
      <li><a href="#adding-groups-in-manageiq">Adding Groups In ManageIQ</a></li>
      <li><a href="#example-authentication-config">Example Authentication Config</a></li>
    </ul>
  </li>
</ul>

<h1 id="technologies-supporting-manageiq-authentication-modes">Technologies Supporting ManageIQ Authentication Modes</h1>
<hr />

<p>ManageIQ supports a rich set of different authentication configurations, as outlined in the blog post:
<a href="../auth-overview"><strong>ManageIQ Authentication Overview</strong></a></p>

<p>Many of the issues reported as ManageIQ authentication problems are not directly related to ManageIQ. Instead
many are rooted in failures with the configuration of the underlying authentication technology.</p>

<p>Different technologies are used to implement the supported ManageIQ authentication <em>modes</em>.</p>

<p>Below is a list of the technologies used to implement each of the authentication modes, with pointers to troubleshooting tips.</p>

<h3 id="mode-database"><strong>Mode: Database</strong></h3>

<p>ManageIQ configuration: <strong>Mode: Database</strong>, relies on all <strong>User</strong>, <strong>Group</strong> and <strong>Role</strong> information being stored
  directly in the ManageIQ database to support authentication and authorization.</p>

<ul>
  <li>See: <a href="#capturing-authentication-data-from-manageiq-db"><strong>Capturing Authentication Data From ManageIQ DB</strong></a> for tips
on how to capture the authentication information stored in the ManageIQ Database.</li>
</ul>

<h3 id="mode-ldap-and-mode-ldaps"><strong>Mode: LDAP and Mode: LDAPS</strong></h3>

<p>ManageIQ configurations: <strong>Mode: LDAP and Mode: LDAPS</strong>, are implemented with the MiqLdap driver, which queries LDAP
  servers directly via the <a href="https://rubygems.org/gems/net-ldap/"><strong>net-ldap Rubygem</strong></a>.</p>

<ul>
  <li>See: <a href="#confirming-ldap-configuration"><strong>Confirming LDAP Configuration</strong></a> for tips on how to verify an LDAP configuration.</li>
</ul>

<h3 id="mode-external-httpd"><strong>Mode: External (httpd)</strong></h3>

<p>ManageIQ configurations: <strong>Mode: External (httpd)</strong> is implemented with the <em>The System Security Service Daemon</em>
  <a href="https://docs-old.fedoraproject.org/en-US/Fedora/16/html/System_Administrators_Guide/chap-SSSD_User_Guide-Introduction.html"><strong>(SSSD)</strong></a>.</p>

<ul>
  <li>
    <p><strong>NOTE:</strong> <em>Mode: External (httpd)</em> for <strong><em>SAML</em></strong> does not use <em>SSSD</em>: See: <a href="#saml-a-different-beast"><strong>SAML A different beast</strong></a></p>
  </li>
  <li>
    <p>See: <a href="#confirming-sssd-configuration"><strong>Confirming SSSD Configuration</strong></a> for tips on how to verify an SSSD configuration.</p>
  </li>
</ul>

<h3 id="mode-amazon"><strong>Mode: Amazon</strong></h3>

<p>ManageIQ configuration: <strong>Mode: Amazon</strong>, is used to connect directly to Amazon Cloud Services for authentication.</p>

<ul>
  <li>Information regarding troubleshooting this configuration will be added in the future.</li>
</ul>

<h1 id="manageiq-groups-and-roles">ManageIQ Groups and Roles</h1>
<hr />

<p>Authentication groups are used to associate a user to ManageIQ <strong>Authorization Roles</strong></p>

<p>ManageIQ uses the concept of a <strong>Role</strong> to limit the functionality a user is <em>Authorized</em> to perform.</p>

<p>For an overview of ManageIQ <strong>Roles</strong> see: <a href="http://manageiq.org/docs/get-started/basic-configuration"><strong>ManageIQ Basic Configuration</strong></a></p>

<p>In brief:</p>
<ol>
  <li>A user is associated with groups in the Identity Provider (<strong>IdP</strong>)</li>
  <li>A group is associated with an ManageIQ role in ManageIQ</li>
  <li>When a user logs in to ManageIQ their credentials are <strong>Authenticated</strong> by the IdP.</li>
  <li>The IdP can the provide a list of groups the user belongs to.</li>
  <li>ManageIQ determines if one of the groups reported by the IdP for the user is stored in the ManageIQ database.</li>
  <li>If found ManageIQ will <strong>Authorize</strong> the user to have the <strong>Role</strong> associated with the <strong>Group</strong></li>
</ol>

<p><strong>NOTE:</strong> <strong>Groups</strong> with associated <strong>Roles</strong> must be manually created in the ManageIQ database.</p>

<h1 id="manageiq-authentication-data">ManageIQ Authentication Data</h1>
<hr />

<p>ManageIQ authentication related configuration data is maintained in the ManageIQ Database and ManageIQ authentication related events are recorded in the ManageIQ logs.</p>

<h3 id="authentication-settings-user-and-group-information-are-stored-in-the-manageiq-database"><strong>Authentication settings</strong>, <strong>User</strong> and <strong>Group</strong> information are stored in the ManageIQ database.</h3>

<ul>
  <li>See: <a href="#capturing-authentication-data-from-manageiq-db"><strong>Capturing Authentication Data From ManageIQ DB</strong></a> for tips
on how to capture the authentication information stored in the ManageIQ Database.</li>
</ul>

<h3 id="manageiq-authentication-events-are-captured-in-log-files"><strong>ManageIQ Authentication Events are captured in log files.</strong></h3>

<ul>
  <li>See: <a href="#Capturing ManageIQ Log Files"><strong>Capturing ManageIQ Log Files</strong></a> for tips on how to capture the ManageIQ logs.</li>
</ul>

<h1 id="saml-a-different-beast">SAML A different beast</h1>
<hr />

<p>Authentication using SAML is a bit of a different beast. Although it is configured in ManageIQ as <em>Mode: External (httpd)</em> it does not use <em>SSSD</em>.
Instead, the mod_auth_mellon Apache module is used to make the connection to an Identity Provider (IdP) that supports SAML, e.g. <a href="http://www.keycloak.org/"><strong>Keycloak</strong></a>.</p>

<p>This <a href="https://jdennis.fedorapeople.org/doc/mellon-user-guide/mellon_user_guide.html">Users Guide</a> provides an extensive description of mod_auth_mellon.</p>

<p>Because SAML does not use SSSD, unlike the other ManageIQ <em>Mode: External (httpd)</em> configurations, it is not possible to verify
a SAML configuration with <a href="https://dbus.freedesktop.org/doc/dbus-send.1.html"><strong>dbus-send</strong></a></p>

<h3 id="diagnosing-saml-configurations-in-manageiq">Diagnosing SAML configurations in ManageIQ.</h3>

<ul>
  <li>Use <a href="https://addons.mozilla.org/en-US/firefox/addon/saml-tracer/"><strong>SAML tracer</strong></a>  web browser plug in.</li>
  <li>Configure Keycloak to <strong><em>Do not encrypt assertions</em></strong> so <strong>SAML Tracer</strong> can display text</li>
  <li>
    <p>Debugging the Apache modules on an ManageIQ appliance</p>

    <p>To aid in the debugging of issues encountered when using SAML the Apache log level
can be increased to debug on the ManageIQ appliance.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># vim /etc/httpd/conf.d/manageiq-https-application.conf
...
LogLevel debug
...
</code></pre></div>    </div>

    <p>Then restart the httpd service</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl restart httpd
</code></pre></div>    </div>

    <p>Then attemp to perform a SAML authentication while tailing the ssl_error.log file.</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># tail -f /var/www/miq/vmdb/log/apache/ssl_error.log

</code></pre></div>    </div>

    <p>NOTE: Once any issues have been resolved return the log level to warn:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># vim /etc/httpd/conf.d/manageiq-https-application.conf
...
LogLevel warn
...
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="common-saml-configuration-mistakes">Common SAML configuration mistakes:</h3>

<ul>
  <li>
    <p>Hostname must be DNS resolvable.</p>

    <p>SAML requires DNS resolvable hostnames, IP addresses and unresolvable hostnames will not work.</p>

    <p>Ensure the hostname assigned to the ManageIQ appliance is resolvable on the SAML identity provider and the
client running the browser used to access the ManageIQ appliance UI.</p>

    <p>Also ensure the hostname assigned to the SAML IdP is resolvable on the ManageIQ appliance and the
client running the browser used to access the ManageIQ appliance UI.</p>
  </li>
  <li>
    <p>Unsynchronized system times</p>

    <p>A common issue occures when the date on the SAML identity provider and the ManageIQ appliance are out of sync. This configuration error can result in <a href="/assets/images/blog/auth_saml_bad_request_date_time.png">this <strong><em>Bad Request</em></strong></a> message being displayed.</p>

    <p>If the Apache LogLevel is set to debug, as described above, errors similar to the bellow will be found in the <strong><em>/var/www/miq/vmdb/log/apache/ssl_error.log</em></strong> log file:</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  SubjectConfirmationData was in the past
    and
  SSL Library Error: error:14094416:SSL routines:ssl3_read_bytes:sslv3 alert certificate unknown
</code></pre></div>    </div>

    <p>The <strong><em>DATE(1)</em></strong> command can be used on the SAML identity provider and the ManageIQ appliance to confirm the dates on each are synchronized.</p>
  </li>
  <li>
    <p>Incorrectly configured SAML <strong><em>client</em></strong> mappers</p>

    <ul>
      <li>The SAML client mappers must be appropriately configured, especially the case or each field.</li>
      <li>Follow these screenshots: <a href="/assets/images/blog/auth_saml_mapper_fullname.png">fullname</a>,
<a href="/assets/images/blog/auth_saml_mapper_firstname.png">firstname</a>,
<a href="/assets/images/blog/auth_saml_mapper_lastname.png">lastname</a>,
<a href="/assets/images/blog/auth_saml_mapper_username.png">username</a>,
<a href="/assets/images/blog/auth_saml_mapper_email.png">email</a>,
<a href="/assets/images/blog/auth_saml_mapper_groups.png">groups</a></li>
    </ul>
  </li>
</ul>

<h1 id="common-misconceptions">Common Misconceptions</h1>
<hr />

<ul>
  <li>
    <p>Groups are not auto-created</p>

    <ul>
      <li>The groups a user belongs to must be manually created in the ManageIQ DB, unless they already exist.</li>
    </ul>
  </li>
  <li>
    <p>External Authentication LDAP is not the same as Mode: LDAP(S)</p>

    <ul>
      <li>For a description of the difference see - <a href="../auth-overview"><strong>ManageIQ Authentication Overview</strong></a></li>
    </ul>
  </li>
  <li>
    <p>Authentication is not Authorization</p>

    <ul>
      <li><strong>Authentication</strong> addresses if the specified user and password are valid.</li>
      <li><strong>Authorization</strong> addresses what an valid <strong><em>Authenticated</em></strong> user is allowed to do.</li>
    </ul>
  </li>
  <li>
    <p>External authentication can not be configured with the <strong><em>appliance_console</em></strong> against non-<a href="https://www.freeipa.org/page/Main_Page"><strong>IPA</strong></a> servers.</p>

    <ul>
      <li>The <strong><em>appliance_console’s</em></strong> option: <strong><em>Configure External Authentication (httpd)</em></strong> runs <a href="https://www.freeipa.org/page/Client"><strong>ipa-client-install</strong></a> to configure an IPA client and <strong><em>requires</em></strong> an IPA server be configured as the IdP.</li>
    </ul>
  </li>
</ul>

<!--
- Unicorns do exist. They're just not authentic.
-->

<h1 id="reporting-authentication-issues">Reporting Authentication Issues</h1>
<hr />

<p>When reporting an ManageIQ Authentication issue the below information should be gathered and included
  in the report.</p>

<ol>
  <li>The <strong>Authentication settings</strong>, <strong>User</strong> and <strong>Group</strong> information from the ManageIQ database as described
in section: <a href="#capturing-authentication-data-from-manageiq-db"><strong>Capturing Authentication Data From ManageIQ DB</strong></a></li>
  <li>Attach the ManageIQ log files. See: <a href="#capturing-manageiq-log-files"><strong>Capturing ManageIQ Log Files</strong></a></li>
  <li>If configured for <strong><em>Mode: LDAP(S)</em></strong> is the <a href="https://technicalnotes.wordpress.com/2014/04/19/openldap-setup-with-memberof-overlay/"><strong>memberof overlay</strong></a>
being used on the LDAP server?</li>
  <li>Can a list of groups for a specific user be found in the <strong><em>Adding a new Group</em></strong> configuration page?
see: <a href="#adding-groups-in-manageiq"><strong>Adding Groups In ManageIQ</strong></a></li>
  <li>If configured for <strong><em>Mode: LDAP(S)</em></strong> provide the output from ldapsearch. See: <a href="#confirming-ldap-configuration"><strong>Confirming LDAP Configuration</strong></a></li>
  <li>If configured for <strong><em>Mode: External (httpd)</em></strong>:
    <ul>
      <li>attach the <code class="highlighter-rouge">/etc/sssd/sssd.conf</code></li>
      <li>provide the output from dbus-send. See: <a href="#confirming-sssd-configuration"><strong>Confirming SSSD Configuration</strong></a></li>
      <li>If the dbus-send commands fail to return the required information the SSSD configuration must be diagnosed and fixed before attempting to use ManageIQ.
See: <a href="#diagnosing-failed-dbus-commands"><strong>Diagnosing Failed dbus Commands</strong></a></li>
    </ul>
  </li>
</ol>

<h1 id="appendix">Appendix</h1>
<hr />

<p><strong>The Gory Details</strong></p>

<h2 id="capturing-manageiq-log-files">Capturing ManageIQ Log Files</h2>
<hr />

<p>ManageIQ log files are stored in directory <strong><em>/var/www/miq/vmdb/log</em></strong> which on some releases is a symbolic link.
Be sure to include the “h” flag, as indicated below when generating the tar ball of the symbolically linked log directory.</p>

<p>These shell commands shows how to generate the tar ball and verify it’s contents:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cd</span> /var/www/miq/vmdb
<span class="gp">$</span><span class="w"> </span><span class="nb">tar </span>cvfzh my_log_files.tar.gz log
<span class="gp">$</span><span class="w"> </span><span class="nb">tar </span>ztvf my_log_files.tar.gz
</code></pre></div></div>

<h2 id="capturing-authentication-data-from-manageiq-db">Capturing Authentication Data From ManageIQ DB</h2>
<hr />

<p>The below commands can be used on the appliance where the database resides to capture 
the authentication configuration settings, group and user information from the database.</p>

<ul>
  <li>
    <p>This shell command can be used to query the database for the <strong><em>authentication settings</em></strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>/var/www/miq/vmdb/bin/rails runner <span class="s1">'puts Settings.authentication'</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>This shell command can be used to query the database for the list of known <strong><em>groups</em></strong>:</p>
  </li>
  <li>
    <p>The groups returned from the IdP for users expected to be authenticated on ManageIQ must match at least one
group reported by this command. If not one must be manually added using the ManageIQ UI.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>/var/www/miq/vmdb/bin/rails runner <span class="s1">'puts MiqGroup.pluck(:description)'</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>This shell command can be used to query the database for the list of known <strong><em>users</em></strong>:</p>
  </li>
  <li>
    <p>ManageIQ will auto create authenticated and authorized users if <strong>Get User Groups</strong> from the IdP is configured on the ManageIQ Authentication page.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>/var/www/miq/vmdb/bin/rails runner <span class="s1">'puts User.pluck(:userid)'</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="confirming-ldap-configuration">Confirming LDAP Configuration</h2>
<hr />

<p>An LDAP configuration can be confirmed independently from ManageIQ by using the ldapsearch command.</p>

<p>The LDAPSEARCH(1) man page can be found by searching for <strong><em>ldapsearch</em></strong> in the <a href="http://www.openldap.org/software/man.cgi"><strong>Open LDAP man pages</strong></a>.</p>

<p>Follow these steps to run ldapsearch.</p>

<ul>
  <li>
    <p>Step 1. Get the certs from the OpenLdap Serve if using secure LDAP<strong>S</strong> <em>These commands may vary depending on how the certs are managed on the LDAP server.</em></p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp"> #</span><span class="w"> </span>Remove any old certs
<span class="gp">$</span><span class="w"> </span><span class="nb">rm</span> /etc/openldap/certs/&amp;ast<span class="p">;</span>
<span class="go">
</span><span class="gp"> #</span><span class="w"> </span>Copy the certs from the LDAP server:
<span class="gp">$</span><span class="w"> </span>scp root@ldaphost.example.com:/etc/pki/tls/certs/cacert.pem  /etc/openldap/certs/
<span class="gp">$</span><span class="w"> </span>scp root@ldaphost.example.com:/etc/pki/tls/certs/server&amp;ast<span class="p">;</span>.pem /etc/openldap/certs/
<span class="go">
</span><span class="gp"> #</span><span class="w"> </span>Rehash the certs
<span class="gp">$</span><span class="w"> </span>/usr/sbin/cacertdir_rehash /etc/openldap/certs/
</code></pre></div>    </div>
  </li>
  <li>
    <p>Step 2. Update <code class="highlighter-rouge">/etc/openldap/ldap.conf</code> to:</p>

    <p>Here is an example of an <code class="highlighter-rouge">ldap.conf</code>. <em>The values will vary depending on how the certs are managed on the LDAP server.</em></p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">SASL_NOCANON    on
URI             https://ldaphost.example.com:636
BASE            dc=example,dc=com
TLS_REQCERT     demand
TLS_CACERTDIR   /etc/openldap/certs
TLS_CACERT      /etc/openldap/certs/cacert.pem
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Step 3. Verify the cert with openssl and LDAP configuration with openssl. For example:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>openssl s_client <span class="nt">-connect</span> ldaphost.example.com:636 <span class="nt">-CAfile</span> /etc/openldap/certs/cacert.pem
<span class="gp">$</span><span class="w"> </span>openssl s_client <span class="nt">-showcerts</span> <span class="nt">-connect</span> ldaphost.example.com:636
</code></pre></div>    </div>
  </li>
  <li>
    <p>The flags used in the <code class="highlighter-rouge">ldapsearch</code> examples are:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">-x Use simple authentication instead of SASL.

-H ldaphost

-b searchbase
   Use  searchbase  as the starting point for the search instead of the default.

-D binddn
   Use the Distinguished Name binddn to bind to the LDAP directory.
   For SASL binds, the server is expected to ignore this value.

-w passwd
   Use passwd as the password for simple authentication.

-d debuglevel
   Set the LDAP debugging level to debuglevel. ldapsearch must be compiled with
   LDAP_DEBUG defined for this option to have any effect.
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Step 4. Run non-secure <code class="highlighter-rouge">ldapsearch</code></p>

    <p>Specify <code class="highlighter-rouge">ldap</code> protocol and port with a binddn and password</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://ldaphost.example.com:389  <span class="nt">-b</span> <span class="s2">"dc=example,dc=com"</span>  <span class="nt">-D</span> <span class="s2">"cn=Manager,dc=example,dc=com"</span> <span class="nt">-w</span> password
</code></pre></div>    </div>
  </li>
  <li>
    <p>Step 5. Run <code class="highlighter-rouge">ldapsearch</code> using Transport Layer Security <strong><em>TLS</em></strong></p>

    <p>Specify <code class="highlighter-rouge">ldap</code> protocol and port but do not specify binddn or password will result in a TLS exchange.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://ldaphost.example.com:389  <span class="nt">-b</span> <span class="s2">"dc=example,dc=com"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Step 6. Run <code class="highlighter-rouge">ldapsearch</code> using Secure Sockets Layer <strong><em>SSL</em></strong></p>

    <p>Specify <code class="highlighter-rouge">ldaps</code> protocol and port will result in SSL exchange.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldaps://ldaphost.example.com:636  <span class="nt">-b</span> <span class="s2">"dc=example,dc=com"</span>
</code></pre></div>    </div>

    <p>The <code class="highlighter-rouge">-d</code> flag can be used to produce debugging information.</p>

    <p>Diagnosing <code class="highlighter-rouge">ldapsearch</code> failures is beyond the scope of this blog.</p>
  </li>
</ul>

<h2 id="confirming-sssd-configuration">Confirming SSSD Configuration</h2>
<hr />

<p>ManageIQ configurations: <strong>Mode: External (httpd)</strong> is implemented with the <em>The System Security Service Daemon</em>
  <a href="https://docs-old.fedoraproject.org/en-US/Fedora/16/html/System_Administrators_Guide/chap-SSSD_User_Guide-Introduction.html"><strong>(SSSD)</strong></a>.</p>

<p>For more information see: <a href="#technologies-supporting-manageiq-authentication-modes"><strong>Technologies Supporting ManageIQ Authentication Modes</strong></a></p>

<p>SSSD can be exercised independently of ManageIQ using <a href="https://dbus.freedesktop.org/doc/dbus-send.1.html"><strong>dbus-send</strong></a></p>

<p>Before attempting to configure ManageIQ authentication directly the <strong><em>dbus-send</em></strong> command should be used to confirm the external
  authentication technology is functioning and correctly configured.</p>

<h3 id="dbus-send--getuserattr"><strong><em>dbus-send / GetUserAttr</em></strong></h3>

<p>This <strong><em>dbus-send / GetUserAttr</em></strong> command can be used to confirm all of the user attributes used
by ManageIQ authentication are correctly provided by the underlying technology.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>dbus-send <span class="se">\</span>
  <span class="nt">--print-reply</span> <span class="se">\</span>
  <span class="nt">--system</span> <span class="se">\</span>
  <span class="nt">--dest</span><span class="o">=</span>org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe org.freedesktop.sssd.infopipe.GetUserAttr <span class="se">\</span>
  string:mshiffrin array:string:mail,givenname,sn,displayname,domainname
</code></pre></div></div>

<p>The output from the above <strong><em>dbus-send / GetUserAttr</em></strong> command should look similar to the following:</p>

<p><code class="highlighter-rouge">Note:</code> The <strong><em>domainname</em></strong> attribute became available in the Gaprindashvili release and is not available in older releases of ManageIQ.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">method return sender=:1.40 -&gt;</span><span class="w"> </span><span class="nv">dest</span><span class="o">=</span>:1.48 <span class="nv">reply_serial</span><span class="o">=</span>2
<span class="go">   array [
      dict entry(
         string "mail"
         variant             array [
               string "mshiffrin@example.com"
            ]
      )
      dict entry(
         string "givenname"
         variant             array [
               string "Mikaela"
            ]
      )
      dict entry(
         string "sn"
         variant             array [
               string "Shiffrin"
            ]
      )
      dict entry(
         string "displayname"
         variant             array [
               string "Mikaela Shiffrin"
            ]
      )
      dict entry(
         string "domainname"
         variant             array [
               string "example.com"
            ]
      )
   ]
</span></code></pre></div></div>

<h3 id="dbus-send--getusergroups"><strong><em>dbus-send / GetUserGroups</em></strong></h3>

<p>This <strong><em>dbus-send / GetUserGroups</em></strong> command can be used to confirm all of the user’s groups are correctly provided by the underlying technology.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>dbus-send <span class="se">\</span>
  <span class="nt">--print-reply</span> <span class="se">\</span>
  <span class="nt">--system</span> <span class="se">\</span>
  <span class="nt">--dest</span><span class="o">=</span>org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe org.freedesktop.sssd.infopipe.GetUserGroups <span class="se">\</span>
  string:mshiffrin
</code></pre></div></div>

<p>The output from the above <strong><em>dbus-send / GetUserAttr</em></strong> command should look similar to the following:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">method return sender=:1.40 -&gt;</span><span class="w"> </span><span class="nv">dest</span><span class="o">=</span>:1.189 <span class="nv">reply_serial</span><span class="o">=</span>2
<span class="go">   array [
      string "evmgroup-super_administrator"
      string "gs-group"
   ]
</span></code></pre></div></div>

<ul>
  <li>If these dbus-send commands fail to return the required information the SSSD configuration must be diagnosed and fixed before attempting to use ManageIQ.
See: <a href="#diagnosing-failed-dbus-commands"><strong>Diagnosing Failed dbus Commands</strong></a></li>
</ul>

<h2 id="diagnosing-failed-dbus-commands">Diagnosing Failed dbus Commands</h2>
<hr />

<p>If the <strong><em>dbus-send</em></strong> commands described in section <a href="#confirming-sssd-configuration"><strong>Confirming SSSD Configuration</strong></a>
do not succeed the SSSD configuration can be diagnosed by doing the following:</p>

<ul>
  <li>
    <p>Add <strong><em>debug_level=9</em></strong> to each of the sections of the SSSD configuration file: <strong><em>/etc/sssd/sssd.conf</em></strong></p>
  </li>
  <li>
    <p>Restart the sssd service and confirm it is running.</p>

    <p>If it does not restart there could be errors in the <code class="highlighter-rouge">/etd/sssd/sssd.conf</code> file that need to be addressed.</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl restart sssd.service
<span class="gp">$</span><span class="w"> </span>systemctl status sssd.service
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="highlighter-rouge">Note:</code> If updates are done to the  <strong><em>/etc/sssd/sssd.conf</em></strong> file and not immediately seen when authenticating,
 then clean the SSSD cache as follows and restart the service:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>sss_cache <span class="nt">-E</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>tail the sssd log files</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">tail</span> <span class="nt">-f</span> /var/log/sssd/&amp;ast<span class="p">;</span>.log
</code></pre></div>    </div>
  </li>
  <li>
    <p>Rerun the <strong><em>dbus-send</em></strong> commands described in section <a href="#confirming-sssd-configuration"><strong>Confirming SSSD configuration</strong></a></p>
  </li>
</ul>

<h2 id="adding-groups-in-manageiq">Adding Groups In ManageIQ</h2>
<hr />

<p>Groups can be manually added in ManageIQ <strong><em>and</em></strong> they can be retrieving for a specified user from the configured IdP.
Retrieving them is a good test to confirm connectivity to the IdP server and it is reporting group membership for
the specified user. Doing this is analogous to using the <strong><em>dbus-send / GetUserGroups</em></strong> command.</p>

<p><code class="highlighter-rouge">Note:</code> <strong><em>Look up Groups</em></strong> does not work with SAML.</p>

<p>Look up groups for a specific user with ManageIQ by doing:</p>

<ol>
  <li>Using the ManageIQ UI navigate to <em>Configuration</em> -&gt; <em>Access Control</em> -&gt; <em>Groups</em> -&gt; <em>Configuration</em> -&gt; <em>Add a new Group</em></li>
  <li>Check <strong><em>Look up Groups</em></strong>, provide the credentials if necessary for the specific configuration.</li>
  <li>Click <em>Retrieve</em></li>
  <li>Near the top of the page a new drop-down should appear populated with group names the specified user is associated with on the IdP</li>
</ol>

<h2 id="example-authentication-config">Example Authentication Config</h2>
<hr />

<p>This example, with screenshots, shows one possible authentication configuration.</p>

<ul>
  <li>
    <p>This <a href="/assets/images/blog/my_ad_miqldap_auth_config.png">Authentication Configuration page screenshot</a> shows a configuration for Active Directory with <strong><em>Mode: LDAP(s)</em></strong>, <strong>User Type</strong> of <strong>Sam Account Name</strong> and <strong>Get User Groups from LDAP</strong> set.</p>
  </li>
  <li>
    <p>This <a href="/assets/images/blog/my_ad_miqldap_group_config.png">group add page screenshot</a> depicts one example of manually adding a new group by looking up the groups for user <strong>testuser1</strong> in the Identity Provider.</p>

    <p>It is a requirement that at least one group reported by the Identity Provider for each user match a group in the ManageIQ database.
Some default groups are provided, others must be manually created.
 For more information see: <a href="#adding-groups-in-manageiq"><strong>Adding Groups In ManageIQ</strong></a></p>
  </li>
  <li>
    <p>The below examples of the <strong>ldapsearch</strong> command can be used to confirm a user is configured along with group membership associations via the <strong>memberof overlay</strong>.</p>

    <p>When configurng for <strong><em>Mode: LDAP(S)</em></strong> the <a href="https://technicalnotes.wordpress.com/2014/04/19/openldap-setup-with-memberof-overlay/"><strong>memberof overlay</strong></a> is required by default.</p>
  </li>
  <li>
    <p>ldapsearch example using userPrincipalName</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ldapsearch -x -LLL \
    -H ldap://MY-AD-server.example.lab.eng.rdu2.redhat.com:389 \
    -b "DC=MY-AD,DC=example,DC=lab,DC=eng,DC=redhat,DC=com" \
    -D "my-ad\testuser1" \
    -w ******** \
    -s sub "(userPrincipalName=testuser1@MY-AD.example.lab.eng.rdu2.redhat.com)" '*' memberof
</code></pre></div>    </div>
  </li>
  <li>
    <p>ldapsearch example using sAMAccountName</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ldapsearch -x -LLL \
    -H ldap://MY-AD-server.example.lab.eng.rdu2.redhat.com:389  \
    -b "DC=MY-AD,DC=example,DC=lab,DC=eng,DC=redhat,DC=com"  \
    -D "my-ad\testuser1" \
    -w ******** \
    -s sub "(sAMAccountName=testuser1)" '*' memberof
</code></pre></div>    </div>
  </li>
</ul>


          </div>
        </article>
      </div>

      <div class="col-xs-12 col-sm-2 blog_side">
          <div class="blog_side-group">
  <h3 class="blog_side-heading">
    Categories
  </h3>

  <ul id="blog_tag_menu" class="blog_menu">
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/announcements">announcements</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/events">events</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/collaboration">collaboration</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/releases">releases</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/sprints">sprints</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/LWIMIQ">LWIMIQ</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/developers">developers</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/tutorials">tutorials</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/ruby">ruby</a>
    </li>
    
  </ul>
</div>

<div class="blog_side-group">
  <h3 class="blog_side-heading">
    Archive
  </h3>

  <ul id="blog_archive_menu" class="blog_menu">
    
    
    

    
    <li class="blog_menu-year">
      <a href="/blog/2020/index.html">
        2020
      </a>
      
        <ul class="blog_menu blog_months">
  
  
  <li class="blog_menu-month">
    <a href="/blog/2020/06/index.html">
      June
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/03/index.html">
      March
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/02/index.html">
      February
    </a>
    
  </li>
  
</ul>

      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2019/index.html">
        2019
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2018/index.html">
        2018
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2017/index.html">
        2017
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2016/index.html">
        2016
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2015/index.html">
        2015
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2014/index.html">
        2014
      </a>
      
    </li>
    
  </ul>
</div>

      </div>

    </div>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li class="active">
    <a href="/blog/">Blog</a>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2020 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
