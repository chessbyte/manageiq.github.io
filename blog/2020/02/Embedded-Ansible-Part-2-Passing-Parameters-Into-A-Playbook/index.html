<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ - Embedded Ansible — Part 2, Passing Parameters Into A Playbook</title>
  <meta name="description" content="Part one of this series described the manageiq_automate and manageiq_vmdb roles that can be used by a playbook to interact with a ManageIQ workflow.">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <link type="text/css" rel="stylesheet" href="/assets/main-8de063b063e781c83c3900f2fb42692885edeac0346d54e22467184ccc393942.css">
  <link rel="canonical" href="http://manageiq.org/blog/2020/12/2020-02-12-Embedded-Ansible-Part-2-Passing-Parameters-Into-A-Playbook/">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li class="active">
    <a href="/blog/">Blog</a>
  </li>
</ul>

  </div>
</header>


    <main data-url="/blog/2020/02/Embedded-Ansible-Part-2-Passing-Parameters-Into-A-Playbook/">
      <div class="blog">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-10">
        <header class="blog_header">
          <h1>
            ManageIQ Blog
          </h1>
        </header>
      </div>
    </div>
    <div class="row"> 
      <div class="col-xs-12 col-sm-10 blog_main">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="page-title" itemprop="name headline">Embedded Ansible — Part 2, Passing Parameters Into A Playbook</h1>

            <div class="post-meta">
              <time datetime="2020-02-12T00:00:00+00:00" itemprop="datePublished">
                Feb 12, 2020
              </time>

              
              <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                by
                <i itemprop="name">
                  Peter McGowan
                </i>
              </span>
              

              <ul class="post-tags">
                
                <li>
                  <a href="/blog/tags/tutorials">tutorials</a>
                </li>
                
              </ul>
            </div>
          </header>

          <div class="post-content" itemprop="articleBody">
            <p><a href="https://www.manageiq.org/blog/2020/02/Embedded-Ansible-Part-1-Built-In-Roles/">Part one of this series</a> described the <em>manageiq_automate</em> and <em>manageiq_vmdb</em> roles that can be used by a playbook to interact with a ManageIQ workflow.</p>

<p>This article will describe how to specify the inventory hosts on which to run an embedded Ansible playbook, and how to pass parameters into Ansible playbook services and methods.</p>

<h2 id="inventory-hosts">Inventory Hosts</h2>
<p>Embedded Ansible does not support the concept of inventory groups, and so a list of IPv4 addresses or resolvable hostnames must be passed to the playbook at run-time.</p>

<p>For playbook services a list of default target hosts can be specified when the service is created, and optionally overridden at order-time using the <em>Hosts</em> service dialog element, as follows:</p>

<p><img src="/assets/images/blog/install_a_package-embedded-2.1.jpg" alt="install_a_package" /></p>

<p>For playbook methods one or more target hosts can be specified in the <em>Hosts</em> dialog when the method is created. This can be a list of IP addresses or hostnames, or a substitution string, for example:</p>

<p><img src="/assets/images/blog/substitution_string-embedded-2.2.jpg" alt="substitution_string" /></p>

<p>The substitution string enables the target <em>hosts</em> value to be dynamically translated at run-time and passed to the playbook, enhancing the flexibility of the playbook method.</p>

<h2 id="ansible-playbook-input-parameters">Ansible Playbook Input Parameters</h2>
<p>To benefit from reusability and flexibility, playbooks are often written to work with <em>extra_var</em> variables passed as input parameters. Embedded Ansible playbook services and playbook methods handle input parameters slightly differently.</p>

<h3 id="playbook-service-input-parameters">Playbook Service Input Parameters</h3>
<p>Input parameters for playbook services are defined in the <em>Variables &amp; Default Values</em> section of the service definition WebUI page, as follows:</p>

<p><img src="/assets/images/blog/vars_and_default_values-embedded-2.3.jpg" alt="vars_and_default_values" /></p>

<p>These variables and their string values are passed into the playbook as extra_vars when the playbook is launched.</p>

<p>The default values can optionally be overridden from a service dialog when the service is ordered. Any of the service dialog’s elements that are named with the prefix “param_” will be passed as extra_vars to the playbook (with the string “param_” removed).</p>

<p>If a playbook service is ordered programmatically from Ruby then input parameters can be passed via the options hash to the <code class="language-plaintext highlighter-rouge">create_service_provision_request</code> call, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREDENTIAL_CLASS = "ManageIQ_Providers_EmbeddedAnsible_AutomationManager_MachineCredential"
TEMPLATE_CLASS   = "ServiceTemplate"

service_template = $evm.vmdb(TEMPLATE_CLASS).where(:name =&gt; 'Install a Package').first
credential       = $evm.vmdb(CREDENTIAL_CLASS).where(:name =&gt; 'Root Password').first
options          = {
  "credential"    =&gt; credential.id, 
  "hosts"         =&gt; "infra1.cloud.uk.bit63.com", 
  "param_package" =&gt; "mlocate"
  }
$evm.execute('create_service_provision_request', service_template, options)
</code></pre></div></div>

<h3 id="playbook-method-input-parameters-aka-method-parameters">Playbook Method Input Parameters (aka Method Parameters)</h3>
<p>The Automate Explorer allows for input parameters (also called method parameters) to be defined when an Ansible playbook method is created. The parameters can be any of the standard data types such as string, boolean, integer, password, etc., for example:</p>

<p><img src="/assets/images/blog/input_params-embedded-2.4.jpg" alt="input_params" /></p>

<p>Input parameters are passed to the playbook as extra_vars, so can be referred to in the playbook just as any other variable. As an example the first input parameter in this screenshot can be accessed using the<br />
<code> "{{ ipam_url }}"  </code> syntax.</p>

<p>As can be seen from the <em><strong>ipam_user</strong></em> parameter name, the value of an input parameter for an Ansible playbook <em>method</em> can be a dynamic variable read from a substitution string at run-time (this substitution is not available for a playbook service).</p>

<p>In this example a prior Ruby method in the workflow would have saved the username into <code class="language-plaintext highlighter-rouge">$evm.root[‘ipam_user’]</code>.</p>

<blockquote>
  <p><strong>Note:</strong> The automation engine’s substitution syntax is <code class="language-plaintext highlighter-rouge">${object#attribute_name}</code> where <em>object</em> can be “/” for the root object, or “” (or “.”) for the current object. For example a substitution string of <code class="language-plaintext highlighter-rouge">${/#dialog_vm_name}</code> would be given the value of <code class="language-plaintext highlighter-rouge">$evm.root['dialog_vm_name']</code> at run-time. A substitution string of <code class="language-plaintext highlighter-rouge">${#username}</code> would be given the value of <code class="language-plaintext highlighter-rouge">$evm.object['username']</code> at run-time.</p>
</blockquote>

<h4 id="querying-input-parameters">Querying Input Parameters</h4>
<p>There are two functions in the <em>manageiq-automate</em> role that can be used to list or query whether an input or method parameter exists. These are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">get_method_parameters</code></li>
  <li><code class="language-plaintext highlighter-rouge">method_parameter_exists</code></li>
</ul>

<p>Their use is illustrated as follows:</p>

<h5 id="get_method_parameters">get_method_parameters</h5>
<p>The <em>get_method_parameters</em> function reads the full list of input parameters with their values, as illustrated below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Get the full list of method parameters (get_method_parameters)
  manageiq_automate:
    workspace: "{{ workspace }}"
    get_method_parameters: yes
  register: get_method_parameters
- debug: msg="Result:"
</code></pre></div></div>

<p>The output is as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASK [Get the full list of method parameters (get_method_parameters)] ***************
ok: [localhost]

TASK [debug] *******************************************************************
ok: [localhost] =&gt; {
    "msg": "Result:{u'ipam_user': u'ipam_admin', u'default_passwd': u'password::********', u'ipam_url': u'https://ipam.company.org', u'manageiq_validate_certs': False}"
}
</code></pre></div></div>

<h5 id="method_parameter_exists">method_parameter_exists</h5>
<p>The <em>method_parameter_exists</em> function checks if a method parameter with a given name exists, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Check if a method parameter called 'ipam_url' exists (method_parameter_exists)
  manageiq_automate:
    workspace: "{{ workspace }}"
    method_parameter_exists:
      parameter: "ipam_url"
  register: method_parameter_exists
- debug: msg="Result:"
</code></pre></div></div>

<p>The output is as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASK [Check if a method parameter called 'ipam_url' exists (method_parameter_exists)] ***
ok: [localhost]

TASK [debug] *******************************************************************
ok: [localhost] =&gt; {
    "msg": "Result:True"
}
</code></pre></div></div>

<p>It should be noted that the return from each of these tasks (stored by the <em>register</em> keyword) is a hash, and value of the return is referenced using the <em>value</em> key of this hash, for example <code class="language-plaintext highlighter-rouge">method_parameter_exists.value</code>.</p>

<h4 id="reading-service-dialog-values-as-input-parameters">Reading Service Dialog Values as Input Parameters</h4>
<p>It is often the case that the values input into a service dialog should be passed to an Ansible playbook method somewhere in the workflow. A typical example is when calling an Ansible playbook method from the VM Provision state machine, where the VM provision has been initiated from a service catalog.</p>

<p>The service dialog entries are stored in the service request object’s options hash <code class="language-plaintext highlighter-rouge">:dialog</code> key, the value of which is itself a hash of dialog element name/value pairs.</p>

<p>From the VM Provision state machine this is accessible from <code class="language-plaintext highlighter-rouge">$evm.root['miq_provision'].miq_provision_request.options</code>, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$evm.root['miq_provision'].miq_provision_request.options[:dialog] = {
"dialog_service_name" =&gt; "New Engineering VM", 
"dialog_vm_name" =&gt; "pemcg-eng-03", 
"dialog_option_0_cores_per_socket" =&gt; 2, 
"dialog_option_0_vm_memory" =&gt; 2048, 
"dialog_option_0_hostname" =&gt; "pemcg-eng-03.lon.redhat.com", "Array::dialog_tag_0_department" =&gt; "Classification::1000000000046", 
"password::dialog_option_0_root_password" =&gt; "********"
}
</code></pre></div></div>

<p>To inject the <code class="language-plaintext highlighter-rouge">cores_per_socket</code> value from the service dialog as an input parameter using substitution syntax would therefore require the following input parameter value:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${/#miq_provision.miq_provision_request.get_option(:dialog).fetch(dialog_option_0_cores_per_socket)}
</code></pre></div></div>

<h3 id="encrypted-input-parameters">Encrypted Input Parameters</h3>
<p>The parameters passed to a playbook method are often encrypted, either by definition as a “password” data type in the list of input parameters, or by being encrypted elsewhere in a workflow.</p>

<h4 id="input-parameter-password-data-type">Input Parameter ‘password’ Data Type</h4>
<p>An input parameter can be defined as being of type “password”, for example:</p>

<p><img src="/assets/images/blog/input_params-embedded-2.5.jpg" alt="input_params" /></p>

<p>A parameter of this type is decrypted automatically and is available to the playbook as the named extra variable, for example “{{ scrambled_this }}”. It should be noted that an input parameter that has the text string “password” anywhere in the name will not be passed as a method parameter, and so will not appear in the list of method parameters returned by the <code class="language-plaintext highlighter-rouge">get_method_parameters</code> function. The variable will however be available as an extra_var with the password value decrypted correctly.</p>

<h4 id="password-defined-earlier-in-workflow">Password Defined Earlier in Workflow</h4>
<p>A variable encrypted earlier in the workflow (for example when input into a service dialog) can generally be identified as having a name prefixed by the string “password::”. This signifies that the object is of type <em>MiqPassword</em>.</p>

<p>A password object of this type can be used as an input parameter if it is passed as a string data type, also prefixed by the string “password::”. The encrypted value will be automatically decrypted and is usable by the playbook as the named extra variable.</p>

<p>For example, to inject the <code class="language-plaintext highlighter-rouge">root_password</code> value from the previous service dialog using substitution syntax, an input parameter should be defined with a string data type and the following input parameter value:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> password::${/#miq_provision.miq_provision_request.get_option(:dialog).fetch(password::dialog_option_0_root_password)}
</code></pre></div></div>

<p>A screenshot of these input parameters for illustration is as follows:</p>

<p><img src="/assets/images/blog/input_params-embedded-2.6.jpg" alt="input_params" /></p>

<h2 id="summary">Summary</h2>
<p>In part two of this series we have looked at how inventory hosts are defined for embedded Ansible playbook methods and services. We have also seen how input parameters can be passed to playbook services and methods and decrypted if necessary, and how to retrieve and use service dialog element values.</p>

<p>Each of these techniques is usable for standalone playbooks, however the real benefit of embedded Ansible comes when using playbook methods as part of a larger automation workflow. Part three will examine how a playbook can interact with other components in an automation workflow.</p>

          </div>
        </article>
      </div>

      <div class="col-xs-12 col-sm-2 blog_side">
          <div class="blog_side-group">
  <h3 class="blog_side-heading">
    Categories
  </h3>

  <ul id="blog_tag_menu" class="blog_menu">
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/announcements">announcements</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/events">events</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/collaboration">collaboration</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/releases">releases</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/sprints">sprints</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/LWIMIQ">LWIMIQ</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/developers">developers</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/tutorials">tutorials</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/ruby">ruby</a>
    </li>
    
  </ul>
</div>

<div class="blog_side-group">
  <h3 class="blog_side-heading">
    Archive
  </h3>

  <ul id="blog_archive_menu" class="blog_menu">
    
    
    

    
    <li class="blog_menu-year">
      <a href="/blog/2020/index.html">
        2020
      </a>
      
        <ul class="blog_menu blog_months">
  
  
  <li class="blog_menu-month">
    <a href="/blog/2020/10/index.html">
      October
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/09/index.html">
      September
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/08/index.html">
      August
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/07/index.html">
      July
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/06/index.html">
      June
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/03/index.html">
      March
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/02/index.html">
      February
    </a>
    
  </li>
  
</ul>

      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2019/index.html">
        2019
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2018/index.html">
        2018
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2017/index.html">
        2017
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2016/index.html">
        2016
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2015/index.html">
        2015
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2014/index.html">
        2014
      </a>
      
    </li>
    
  </ul>
</div>

      </div>

    </div>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li class="active">
    <a href="/blog/">Blog</a>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
      
      <li>
        <a href="https://github.com/ManageIQ/manageiq.org/edit/master/site/_posts/2020-02-12-Embedded-Ansible-Part-2-Passing-Parameters-Into-A-Playbook.md">
          <i class="fa fa-pencil"></i>
          Edit this page
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2020 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
