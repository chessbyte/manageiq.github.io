<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ - Embedded Ansible — Part 1, Built-In Ansible Roles</title>
  <meta name="description" content="This is the first of four blog posts in a series written by Peter McGowan about Embedded Ansible capabilities released in ManageIQ Fine.">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <link type="text/css" rel="stylesheet" href="/assets/main-8de063b063e781c83c3900f2fb42692885edeac0346d54e22467184ccc393942.css">
  <link rel="canonical" href="http://manageiq.org/blog/2020/10/2020-02-12-Embedded-Ansible-Part-1-Built-In-Roles/">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li class="active">
    <a href="/blog/">Blog</a>
  </li>
</ul>

  </div>
</header>


    <main data-url="/blog/2020/02/Embedded-Ansible-Part-1-Built-In-Roles/">
      <div class="blog">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-10">
        <header class="blog_header">
          <h1>
            ManageIQ Blog
          </h1>
        </header>
      </div>
    </div>
    <div class="row"> 
      <div class="col-xs-12 col-sm-10 blog_main">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="page-title" itemprop="name headline">Embedded Ansible — Part 1, Built-In Ansible Roles</h1>

            <div class="post-meta">
              <time datetime="2020-02-12T00:00:00+00:00" itemprop="datePublished">
                Feb 12, 2020
              </time>

              
              <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                by
                <i itemprop="name">
                  Peter McGowan
                </i>
              </span>
              

              <ul class="post-tags">
                
                <li>
                  <a href="/blog/tags/tutorials">tutorials</a>
                </li>
                
              </ul>
            </div>
          </header>

          <div class="post-content" itemprop="articleBody">
            <p>This is the first of four blog posts in a series written by Peter McGowan about Embedded Ansible capabilities released in ManageIQ Fine.</p>

<p>The introduction of Embedded Ansible with the Fine release enabled administrators to create services that use Ansible playbooks instead of Ruby methods to perform tasks. Successive versions of ManageIQ have expanded this capability, and automation developers can now construct complex Automate workflows using Ansible playbooks alongside traditional Ruby methods.</p>

<p>Part 1 of this series will discuss two Ansible roles that have been included in Fine and later. The roles enable an embedded Ansible playbook to integrate closely with ManageIQ and participate in an automation workflow. They are:</p>

<p><em>manageiq-core.manageiq-automate</em> — this role provides a simple way of accessing Automate workspace objects. It is usable from playbook methods only.</p>

<p><em>manageiq-core.manageiq-vmdb</em> — this role provides a simple way of manipulating VMDB objects that are exposed via the API. It is usable from both playbook methods and playbook services.</p>

<p>Usage of both roles is demonstrated throughout the remainder of this series of articles.</p>

<h2 id="the-manageiq-automate-role">The manageiq-automate Role</h2>
<p>The <em>manageiq-core.manageiq-automate</em> role can be used by playbook methods (but not services) to interact with ManageIQ automation. This allows a playbook method to participate in an automation workflow and share data with other objects in the workflow’s workspace.</p>

<p>The following is an example of how the role can be used:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  vars:
  - manageiq_validate_certs: false

  roles:
  - manageiq-core.manageiq-automate

  tasks:
  - name: Get the "rhel_subscription_pool" attribute from a configuration domain instance
    manageiq_automate:
      workspace: "{{ workspace }}"
      get_attribute:
        object: "/Configuration/OpenShift/Parameters"
        attribute: "rhel_subscription_pool"
    register: get_attribute_result
</code></pre></div></div>

<p>The role uses a <em>manageiq_validate_certs</em> internal variable to determine whether to validate the SSL connection back to the API. The default for this value is <em>true</em>, but must be overridden to <em>false</em> if the default self-signed SSL certificate is used. This can be done using a playbook var or input parameter (i.e. extra_var) called <em>manageiq_validate_certs</em> with the boolean value of <em>false</em>, for example:</p>

<p><img src="/assets/images/blog/input_params-embedded-1.1.jpg" alt="input_params" /></p>

<h2 id="functions">Functions</h2>
<p>The <em>manageiq-automate</em> module contains many functions that can be broadly divided into four categories, as follows.</p>

<h3 id="working-with-input-parameters">Working with Input Parameters</h3>
<p>A playbook method’s input parameters can be queried and retrieved using the following functions:</p>

<p><code class="language-plaintext highlighter-rouge">method_parameter_exists</code><br />
<code class="language-plaintext highlighter-rouge">get_method_parameters</code><br />
<code class="language-plaintext highlighter-rouge">get_method_parameter</code><br />
<code class="language-plaintext highlighter-rouge">get_decrypted_method_parameter</code></p>

<h3 id="working-with-workspace-objects">Working with Workspace Objects</h3>
<p>Workspace objects (instances that are already loaded in the $evm workspace) can be queried using the following functions:</p>

<p><code class="language-plaintext highlighter-rouge">object_exists</code><br />
<code class="language-plaintext highlighter-rouge">get_object_names</code><br />
<code class="language-plaintext highlighter-rouge">get_object_attribute_names</code><br />
<code class="language-plaintext highlighter-rouge">get_vmdb_object</code></p>

<h3 id="working-with-object-attributes">Working with Object Attributes</h3>
<p>Workspace object attributes can be queried, retrieved and set using the following functions:</p>

<p><code class="language-plaintext highlighter-rouge">attribute_exists</code><br />
<code class="language-plaintext highlighter-rouge">get_attribute</code><br />
<code class="language-plaintext highlighter-rouge">get_decrypted_attribute</code><br />
<code class="language-plaintext highlighter-rouge">set_attribute</code><br />
<code class="language-plaintext highlighter-rouge">set_attributes</code><br />
<code class="language-plaintext highlighter-rouge">set_encrypted_attribute</code></p>

<h3 id="working-with-state-machines">Working with State Machines</h3>
<p>A state machine’s state variables can be retrieved or set using the following functions when a playbook method is running in the state machine:</p>

<p><code class="language-plaintext highlighter-rouge">get_state_var_names</code><br />
<code class="language-plaintext highlighter-rouge">state_var_exists</code><br />
<code class="language-plaintext highlighter-rouge">get_state_var</code><br />
<code class="language-plaintext highlighter-rouge">set_state_var</code><br />
<code class="language-plaintext highlighter-rouge">set_retry</code></p>

<h2 id="return-values">Return Values</h2>
<p>The <code class="language-plaintext highlighter-rouge">get_*</code> and <code class="language-plaintext highlighter-rouge">*_exists</code> functions return their values into a variable using the <em>register</em> command, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Get the "rhel_subscription_pool" attribute from a configuration domain
  manageiq_automate:
    workspace: "{{ workspace }}"
    get_attribute:
      object: "/Configuration/OpenShift/Parameters"
      attribute: "rhel_subscription_pool"
  register: get_attribute_result
- debug: msg="Result:"
</code></pre></div></div>

<p>The return value from these commands is typically a hash, and the value of interest has the <code class="language-plaintext highlighter-rouge">value</code> key in this hash. For example, the debug line above will print the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ok: [localhost] =&gt; {
    "msg": "Result:{'changed': False, 'value': 'Red Hat OpenShift Container Platform, Premium*', 'failed': False}"
}
</code></pre></div></div>

<p>If the variable is to be used elsewhere in the playbook it should therefore be referenced using the <code class="language-plaintext highlighter-rouge">value</code> key, for example
<code> {{ get_attribute_result.value }} </code>.</p>

<p>Some of the functions return an object. For example, <em>get_decrypted_attribute</em> returns a hash whose <em>value</em> key itself points to a further object hash:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Get the "ldap_user_password" encrypted attribute from a configuration domain
  manageiq_automate:
    workspace: "{{ workspace }}"
    get_decrypted_attribute:
      object: "/Configuration/OpenShift/Parameters"
      attribute: "ldap_user_password"
  register: get_decrypted_attribute_result
- debug: msg="Result:"

ok: [localhost] =&gt; {
    "msg": "Result:{'changed': False, 'value': {'object': '/Configuration/OpenShift/Parameters', 'attribute': 'ldap_user_password', 'value': 'so_secret'}, 'failed': False}"
}
</code></pre></div></div>

<p>If the variable is to be used elsewhere in the playbook it should be referenced with the <code class="language-plaintext highlighter-rouge">value.value</code> key, for example
<code> {{ get_decrypted_attribute_result.value.value }} </code> .</p>

<h2 id="the-manageiq-vmdb-role">The manageiq-vmdb Role</h2>
<p>VMDB objects that are accessible via the RESTful API can be accessed using functions defined in the <em>manageiq-core.manageiq-vmdb</em> role, documented <a href="https://github.com/syncrou/manageiq-vmdb">here</a>. The role is usable from both playbook services and playbook methods.</p>

<p>Like the <em>manageiq-automate</em> role, this role also uses a <em>manageiq_validate_certs</em> internal variable to determine whether to validate the SSL connection back to the API. The default for this value is <em>true</em>, and this must be overridden to <em>false</em> if the default self-signed SSL certificate is used.</p>

<p>The following is an example of how the role can be used:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  vars:
  - manageiq_validate_certs: false

  roles:
  - manageiq-core.manageiq-vmdb

  tasks:
  - name: Get the service object
    manageiq_vmdb:
      href: "{{ manageiq.service }}"
    register: service

  - name: Get the VM object
    manageiq_vmdb:
      href: "vms/18"
    register: vm

  - name: Rename the service
    manageiq_vmdb:
      vmdb: "{{ service }}"
      action: edit
      data:
        name: "New Engineering VM"
        description: "VM created on {{ lookup('pipe', 'date +%Y-%m-%d\\ %H:%M') }}"

  - name: Add the VM to the service
    manageiq_vmdb:
      vmdb: "{{ service }}"
      action: add_resource
      data:
        resource:
          href: "{{ vm.href }}"
</code></pre></div></div>

<p>The actions available to an object are those described in the API reference guide.</p>
<h2 id="cfme-appliance-hostname">CFME Appliance Hostname</h2>
<p>If no appliance hostname has been set from <em>appliance_console</em>, the embedded Ansible provider may fail to connect back to itself when running these roles. An error such as the following may be logged:</p>

<p><code class="language-plaintext highlighter-rouge">MIQ(ManageIQ::Providers::EmbeddedAnsible::Provider#authentication_check_no_validation) type: ["default"] for [2] [Embedded Ansible] Validation failed: error, Failed to open TCP connection to https:443 (getaddrinfo: Name or service not known)</code></p>

<p>To prevent this error, always ensure that the appliance hostname has been defined.</p>

<h2 id="summary">Summary</h2>
<p>This article has described two very useful Ansible roles that are supplied out-of-the-box with ManageIQ. The following articles in this series illustrate further how the roles can be used by a playbook that is run as part of an automation workflow.</p>

          </div>
        </article>
      </div>

      <div class="col-xs-12 col-sm-2 blog_side">
          <div class="blog_side-group">
  <h3 class="blog_side-heading">
    Categories
  </h3>

  <ul id="blog_tag_menu" class="blog_menu">
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/announcements">announcements</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/events">events</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/collaboration">collaboration</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/releases">releases</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/sprints">sprints</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/LWIMIQ">LWIMIQ</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/developers">developers</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/tutorials">tutorials</a>
    </li>
    
    <li class="blog_menu-tag">
      <a href="/blog/tags/ruby">ruby</a>
    </li>
    
  </ul>
</div>

<div class="blog_side-group">
  <h3 class="blog_side-heading">
    Archive
  </h3>

  <ul id="blog_archive_menu" class="blog_menu">
    
    
    

    
    <li class="blog_menu-year">
      <a href="/blog/2020/index.html">
        2020
      </a>
      
        <ul class="blog_menu blog_months">
  
  
  <li class="blog_menu-month">
    <a href="/blog/2020/09/index.html">
      September
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/08/index.html">
      August
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/07/index.html">
      July
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/06/index.html">
      June
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/03/index.html">
      March
    </a>
    
  </li>
  
  <li class="blog_menu-month">
    <a href="/blog/2020/02/index.html">
      February
    </a>
    
  </li>
  
</ul>

      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2019/index.html">
        2019
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2018/index.html">
        2018
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2017/index.html">
        2017
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2016/index.html">
        2016
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2015/index.html">
        2015
      </a>
      
    </li>
    
    <li class="blog_menu-year">
      <a href="/blog/2014/index.html">
        2014
      </a>
      
    </li>
    
  </ul>
</div>

      </div>

    </div>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li class="active">
    <a href="/blog/">Blog</a>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2020 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
